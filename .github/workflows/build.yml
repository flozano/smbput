name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  tests:
    name: Unit and Integration Tests
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Cache Go build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .gocache
            .gomodcache
          key: ${{ runner.os }}-go-${{ hashFiles('go.sum') }}

      - name: Run unit tests
        run: make test

      - name: Run integration tests
        run: make test-integration

  build:
    name: Build and Test
    needs: tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            goarm: ''
            suffix: ''
            artifact: smbput-linux-amd64
          - goos: linux
            goarch: arm
            goarm: '5'
            suffix: '-armv5'
            artifact: smbput-linux-arm-v5
          - goos: linux
            goarch: arm
            goarm: '6'
            suffix: '-armv6'
            artifact: smbput-linux-arm-v6
          - goos: linux
            goarch: arm
            goarm: '7'
            suffix: '-armv7'
            artifact: smbput-linux-arm-v7
          - goos: linux
            goarch: arm64
            goarm: ''
            suffix: '-arm64'
            artifact: smbput-linux-arm64
          - goos: darwin
            goarch: amd64
            goarm: ''
            suffix: '-macos-amd64'
            artifact: smbput-darwin-amd64
          - goos: darwin
            goarch: arm64
            goarm: ''
            suffix: '-macos-arm64'
            artifact: smbput-darwin-arm64
          - goos: windows
            goarch: amd64
            goarm: ''
            suffix: '.exe'
            artifact: smbput-windows-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build optimized binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          if [ -n "${{ matrix.goarm }}" ]; then
            export GOARM='${{ matrix.goarm }}'
          else
            unset GOARM
          fi
          CGO_ENABLED=0 go build \
            -trimpath \
            -ldflags="-s -w" \
            -o smbput${{ matrix.suffix }}
          ls -lh smbput${{ matrix.suffix }}

      - name: Install UPX (Linux targets)
        if: matrix.goos == 'linux'
        run: |
          curl -L -o /tmp/upx.tar.xz https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz
          cd /tmp
          tar -xf upx.tar.xz
          sudo install -m 755 upx-4.2.4-amd64_linux/upx /usr/local/bin/
          upx --version

      - name: Compress binary with UPX
        if: matrix.goos == 'linux'
        run: |
          cp smbput${{ matrix.suffix }} smbput${{ matrix.suffix }}-upx
          upx --best --lzma smbput${{ matrix.suffix }}-upx
          ls -lh smbput${{ matrix.suffix }} smbput${{ matrix.suffix }}-upx

      - name: Upload standard binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: smbput${{ matrix.suffix }}
          retention-days: 30

      - name: Upload UPX binary
        if: matrix.goos == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}-upx
          path: smbput${{ matrix.suffix }}-upx
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout history for changelog
        run: git fetch --prune --unshallow --tags

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd artifacts
          for dir in */; do
            artifact="${dir%/}"
            binary=$(ls "$dir")
            cp "$dir/$binary" "../release/${artifact}"
          done
          cd ../release
          ls -lh

      - name: Generate release notes
        id: changelog
        run: |
          CURRENT_TAG="${GITHUB_REF##*/}"
          if git describe --tags --abbrev=0 --exclude "${CURRENT_TAG}" >/tmp/prev_tag 2>/dev/null; then
            PREV_TAG=$(cat /tmp/prev_tag)
            NOTES=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:'- %s (@%an)')
            printf 'notes<<EOF\nChanges since %s:%s%s\nEOF\n' "$PREV_TAG" "\n" "$NOTES" >> "$GITHUB_OUTPUT"
          else
            NOTES=$(git log --pretty=format:'- %s (@%an)')
            printf 'notes<<EOF\nInitial release:%s%s\nEOF\n' "\n" "$NOTES" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body: |
            ## SMB Client Release

            ### Changes since last release
            ${{ steps.changelog.outputs.notes }}

            Each Linux release includes both the standard binary and a UPX-compressed variant.

            ### Available builds:
            - `smbput-linux-amd64` / `smbput-linux-amd64-upx` - Linux x86-64 (plain & UPX)
            - `smbput-linux-arm-v5` / `smbput-linux-arm-v5-upx` - Linux ARMv5 (plain & UPX)
            - `smbput-linux-arm-v6` / `smbput-linux-arm-v6-upx` - Linux ARMv6 (plain & UPX)
            - `smbput-linux-arm-v7` / `smbput-linux-arm-v7-upx` - Linux ARMv7 (plain & UPX)
            - `smbput-linux-arm64` / `smbput-linux-arm64-upx` - Linux ARM64 (plain & UPX)
            - `smbput-darwin-amd64` - macOS Intel
            - `smbput-darwin-arm64` - macOS Apple Silicon
            - `smbput-windows-amd64` - Windows x86-64

            ### Usage:
            ```bash
            export SMB_PASSWORD=your_password
            ./smbput -server HOST -share SHARE -user USER ls /
            ./smbput -server HOST -share SHARE -user USER get remote.txt local.txt
            ./smbput -server HOST -share SHARE -user USER put local.txt remote.txt
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
