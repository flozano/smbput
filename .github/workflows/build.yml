name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  tests:
    name: Unit and Integration Tests
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Cache Go build artifacts
        uses: actions/cache@v4
        with:
          path: |
            .gocache
            .gomodcache
          key: ${{ runner.os }}-go-${{ hashFiles('go.sum') }}

      - name: Run unit tests
        run: make test

      - name: Run integration tests
        run: make test-integration

  build:
    name: Build and Test
    needs: tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            goarm: ''
            suffix: ''
            artifact: smbput-linux-amd64
          - goos: linux
            goarch: arm
            goarm: '5'
            suffix: '-armv5'
            artifact: smbput-linux-arm-v5
          - goos: linux
            goarch: arm
            goarm: '6'
            suffix: '-armv6'
            artifact: smbput-linux-arm-v6
          - goos: linux
            goarch: arm
            goarm: '7'
            suffix: '-armv7'
            artifact: smbput-linux-arm-v7
          - goos: linux
            goarch: arm64
            goarm: ''
            suffix: '-arm64'
            artifact: smbput-linux-arm64
          - goos: darwin
            goarch: amd64
            goarm: ''
            suffix: '-macos-amd64'
            artifact: smbput-darwin-amd64
          - goos: darwin
            goarch: arm64
            goarm: ''
            suffix: '-macos-arm64'
            artifact: smbput-darwin-arm64
          - goos: windows
            goarch: amd64
            goarm: ''
            suffix: '.exe'
            artifact: smbput-windows-amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.3'

      - name: Build optimized binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          CGO_ENABLED=0 go build \
            -trimpath \
            -ldflags="-s -w" \
            -o smbput${{ matrix.suffix }}
          ls -lh smbput${{ matrix.suffix }}

      - name: Install UPX (Linux amd64 only)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          curl -L -o /tmp/upx.tar.xz https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz
          cd /tmp
          tar -xf upx.tar.xz
          sudo install -m 755 upx-4.2.4-amd64_linux/upx /usr/local/bin/
          upx --version

      - name: Compress with UPX (Linux amd64 only)
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        run: |
          cp smbput smbput-upx
          upx --best --lzma smbput-upx
          echo "Original size:"
          ls -lh smbput
          echo "UPX compressed size:"
          ls -lh smbput-upx

      - name: Upload standard binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: smbput${{ matrix.suffix }}
          retention-days: 30

      - name: Upload UPX binary
        if: matrix.goos == 'linux' && matrix.goarch == 'amd64'
        uses: actions/upload-artifact@v4
        with:
          name: smbput-linux-amd64-upx
          path: smbput-upx
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd artifacts
          for dir in */; do
            artifact="${dir%/}"
            binary=$(ls "$dir")
            cp "$dir/$binary" "../release/${artifact}"
          done
          cd ../release
          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          body: |
            ## SMB Client Release

            Binary size comparison (Linux amd64):
            - Standard optimized: ~3.4MB
            - UPX compressed: ~1.5MB (55% smaller!)

            ### Available builds:
            - `smbput-linux-amd64` - Linux x86-64 (optimized)
            - `smbput-linux-amd64-upx` - Linux x86-64 (UPX compressed)
            - `smbput-linux-arm-v5` - Linux ARMv5 (soft-float)
            - `smbput-linux-arm-v6` - Linux ARMv6 (soft-float)
            - `smbput-linux-arm-v7` - Linux ARMv7 (hard-float)
            - `smbput-linux-arm64` - Linux ARM64
            - `smbput-darwin-amd64` - macOS Intel
            - `smbput-darwin-arm64` - macOS Apple Silicon
            - `smbput-windows-amd64` - Windows x86-64

            ### Usage:
            ```bash
            export SMB_PASSWORD=your_password
            ./smbput -server HOST -share SHARE -user USER ls /
            ./smbput -server HOST -share SHARE -user USER get remote.txt local.txt
            ./smbput -server HOST -share SHARE -user USER put local.txt remote.txt
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
